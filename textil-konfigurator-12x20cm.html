
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Textil-Konfigurator mit Griffen (12x20cm)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #controls {
      margin-bottom: 10px;
    }
    #canvasWrapper {
      width: 1200px;
      height: 2000px;
      margin: 0 auto;
      border: 1px dashed #ccc;
      background: transparent;
      position: relative;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .handle {
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Textil-Konfigurator (mit Griffen, 12x20 cm)</h2>
<div id="controls">
  <input type="file" id="svgInput" accept=".svg">
  <button onclick="addText()">Text hinzufügen</button>
  <button onclick="downloadSVG()">Als SVG speichern</button>
</div>

<div id="canvasWrapper">
  <svg id="designArea" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 2000"></svg>
</div>

<script>
  const svg = document.getElementById("designArea");

  document.getElementById("svgInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file || !file.name.endsWith(".svg")) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
      group.setAttribute("transform", "translate(100,100)");
      group.setAttribute("class", "movable");

      const parser = new DOMParser();
      const svgContent = parser.parseFromString(evt.target.result, "image/svg+xml").documentElement;

      const contentGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      for (let child of svgContent.children) {
        contentGroup.appendChild(child.cloneNode(true));
      }

      const moveHandle = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      moveHandle.setAttribute("x", "-10");
      moveHandle.setAttribute("y", "-10");
      moveHandle.setAttribute("width", "20");
      moveHandle.setAttribute("height", "20");
      moveHandle.setAttribute("fill", "#000");
      moveHandle.setAttribute("class", "handle");

      const rotateHandle = document.createElementNS("http://www.w3.org/2000/svg", "text");
      rotateHandle.setAttribute("x", "50");
      rotateHandle.setAttribute("y", "-20");
      rotateHandle.setAttribute("font-size", "20");
      rotateHandle.setAttribute("fill", "red");
      rotateHandle.textContent = "⟳";
      rotateHandle.setAttribute("class", "handle");

      group.appendChild(contentGroup);
      group.appendChild(moveHandle);
      group.appendChild(rotateHandle);
      svg.appendChild(group);

      addMoveListener(group, moveHandle);
      addRotateListener(group, rotateHandle);
    };
    reader.readAsText(file);
  });

  function addText() {
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.textContent = "Dein Text";
    text.setAttribute("x", "100");
    text.setAttribute("y", "100");
    text.setAttribute("font-size", "24");
    text.setAttribute("fill", "#ffffff");
    text.setAttribute("font-family", "Arial");
    text.setAttribute("class", "draggable");
    svg.appendChild(text);
    enableTextEditing(text);
    addMoveListener(text, text);
  }

  function addMoveListener(target, handle) {
    let isDragging = false, offsetX = 0, offsetY = 0;

    handle.addEventListener("mousedown", function(evt) {
      isDragging = true;
      const CTM = target.getCTM();
      offsetX = evt.clientX - CTM.e;
      offsetY = evt.clientY - CTM.f;
      evt.stopPropagation();
    });

    window.addEventListener("mousemove", function(evt) {
      if (!isDragging) return;
      const x = evt.clientX - offsetX;
      const y = evt.clientY - offsetY;
      target.setAttribute("transform", `translate(${x},${y})`);
    });

    window.addEventListener("mouseup", function() {
      isDragging = false;
    });
  }

  function addRotateListener(target, handle) {
    let isRotating = false, center = {};

    handle.addEventListener("mousedown", function(evt) {
      isRotating = true;
      const bbox = target.getBBox();
      const CTM = target.getCTM();
      center = {
        x: CTM.e + bbox.width / 2,
        y: CTM.f + bbox.height / 2
      };
      evt.stopPropagation();
    });

    window.addEventListener("mousemove", function(evt) {
      if (!isRotating) return;
      const dx = evt.clientX - center.x;
      const dy = evt.clientY - center.y;
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      const CTM = target.getCTM();
      const x = CTM.e;
      const y = CTM.f;
      target.setAttribute("transform", `translate(${x},${y}) rotate(${angle},${center.x - x},${center.y - y})`);
    });

    window.addEventListener("mouseup", function() {
      isRotating = false;
    });
  }

  function enableTextEditing(textElement) {
    textElement.addEventListener("dblclick", function() {
      const newText = prompt("Text eingeben:", textElement.textContent);
      if (newText !== null) {
        textElement.textContent = newText;
      }
    });
  }

  function downloadSVG() {
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svg);
    const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "textil-design.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

</body>
</html>
