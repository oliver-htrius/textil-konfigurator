<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Textil-Konfigurator</title>
  <style>
    body { text-align: center; font-family: sans-serif; margin: 20px; }
    #canvasWrapper { width: 336px; height: 560px; margin: auto; border: 1px dashed #ccc; position: relative; }
    svg { width: 100%; height: 100%; }
    .handle { cursor: pointer; user-select: none; }
    .edit-text { fill: white; font-size: 20px; }
  </style>
</head>
<body>
  <h2>Textil-Konfigurator (336 × 560 px)</h2>
  <input type="file" id="svgInput" accept=".svg">
  <button onclick="addText()">Text</button>
  <button onclick="download()">SVG speichern</button><br><br>
  <label>Schriftart:</label>
  <select id="font">
    <option>Arial</option><option>Verdana</option><option>Courier New</option><option>Georgia</option>
  </select>
  <label>Farbe:</label>
  <input type="color" id="color" value="#ffffff"><br><br>

  <div id="canvasWrapper">
    <svg id="svg" viewBox="0 0 336 560" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <script>
    const svg = document.getElementById("svg");

    function createGroup() {
      const g = document.createElementNS(svg.namespaceURI, "g");
      g.setAttribute("transform", "translate(100,100) rotate(0) scale(1)");

      const move = createHandle("circle", { cx: 0, cy: 0, r: 6, fill: "black" });
      const rot = createHandle("text", { x: 40, y: -10, fill: "red", fontSize: 16, textContent: "⟳" });
      const scale = createHandle("text", { x: 40, y: 40, fill: "green", fontSize: 16, textContent: "⤢" });
      const del = createHandle("text", { x: -20, y: -10, fill: "gray", fontSize: 16, textContent: "🗑️" });

      g.appendChild(move);
      g.appendChild(rot);
      g.appendChild(scale);
      g.appendChild(del);

      del.addEventListener("click", () => g.remove());
      rot.addEventListener("click", () => update(g, 0, 0, 15, 1));

      let dragging = false, scaling = false, px = 0, py = 0;
      move.addEventListener("mousedown", e => { dragging = true; px = e.clientX; py = e.clientY; e.stopPropagation(); });
      scale.addEventListener("mousedown", e => { scaling = true; py = e.clientY; e.stopPropagation(); });
      window.addEventListener("mousemove", e => {
        if (dragging) { update(g, e.clientX - px, e.clientY - py, 0, 1); px = e.clientX; py = e.clientY; }
        if (scaling) { update(g, 0, 0, 0, 1 + (e.clientY - py) * 0.01); py = e.clientY; }
      });
      window.addEventListener("mouseup", () => { dragging = false; scaling = false; });

      svg.appendChild(g);
      return g;
    }

    function createHandle(type, attrs) {
      const el = document.createElementNS(svg.namespaceURI, type);
      for (let [key, val] of Object.entries(attrs)) {
        if (key === "textContent") el.textContent = val;
        else el.setAttribute(key, val);
      }
      el.classList.add("handle");
      return el;
    }

    function update(g, dx, dy, dr, ds) {
  let t = g.getAttribute("transform") || "translate(0,0) rotate(0) scale(1)";
  let [x = 0, y = 0, r = 0, s = 1] = (t.match(/[-.\d]+/g) || []).map(Number);
  x += dx; y += dy; r = (r + dr) % 360; s = Math.min(Math.max(s * ds, 0.2), 5);
  g.setAttribute("transform", `translate(${x},${y}) rotate(${r}) scale(${s})`);
}

    }

    function addText() {
      const g = createGroup();
      const foreign = document.createElementNS(svg.namespaceURI, "foreignObject");
      foreign.setAttribute("x", 0);
      foreign.setAttribute("y", 0);
      foreign.setAttribute("width", 200);
      foreign.setAttribute("height", 50);

      const div = document.createElement("div");
      div.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");
      div.contentEditable = true;
      div.innerText = "Dein Text";
      div.style.fontSize = "20px";
      div.style.color = document.getElementById("color").value;
      div.style.fontFamily = document.getElementById("font").value;

      foreign.appendChild(div);
      g.insertBefore(foreign, g.firstChild);
    }

    document.getElementById("svgInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file || !file.name.endsWith(".svg")) return;
      const reader = new FileReader();
      reader.onload = () => {
        const g = createGroup();
        const parsed = new DOMParser().parseFromString(reader.result, "image/svg+xml");
        const inner = document.createElementNS(svg.namespaceURI, "g");
        for (let el of parsed.documentElement.children)
          inner.appendChild(el.cloneNode(true));
        g.insertBefore(inner, g.firstChild);
      };
      reader.readAsText(file);
    });

    function download() {
      const handles = svg.querySelectorAll(".handle");
      handles.forEach(h => h.style.display = "none");
      const serializer = new XMLSerializer();
      const source = serializer.serializeToString(svg);
      const blob = new Blob([source], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "textil-design.svg";
      link.click();
      URL.revokeObjectURL(url);
      handles.forEach(h => h.style.display = "");
    }
  </script>
</body>
</html>
