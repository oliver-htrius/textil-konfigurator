<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Textil Konfigurator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
  <style>
    @font-face {
      font-family: 'Conthrax';
      src: url(https://github.com/oliver-htrius/textil-konfigurator/blob/main/conthrax-sb.ttf) format('truetype');
    }

    body {
      background: transparent;
      color: white;
      font-family: 'Conthrax', sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    #canvas-container {
      position: relative;
      margin: 20px auto;
      width: 480px;
      height: 800px;
    }

    canvas {
      border: 1px dashed white;
    }

    #controls {
      margin: 20px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    button, select, input[type="color"] {
      background: #d4ff00;
      border: none;
      border-radius: 8px;
      color: black;
      padding: 10px 15px;
      font-family: 'Conthrax', sans-serif;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover, select:hover, input[type="color"]:hover {
      background: #b8e600;
    }

    #save-button {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Textil - Konfigurator</h1>

  <div id="controls">
    <input type="file" id="fileUpload" accept="image/svg+xml" />
    <button onclick="toggleGrid()">Raster ein/aus</button>
    <button onclick="addText()">Text hinzuf√ºgen</button>
    <select id="fontSelect">
      <option>Arial</option>
      <option>Courier New</option>
      <option>Times New Roman</option>
    </select>
    <input type="color" id="colorPicker" />
  </div>

  <div id="canvas-container">
    <canvas id="canvas" width="480" height="800"></canvas>
  </div>

  <button id="save-button" onclick="saveSVG()">Konfiguration speichern</button>

  <script>
    const canvas = new fabric.Canvas('canvas', {
      preserveObjectStacking: true
    });

    const exportWidth = 120;
    const exportHeight = 200;

    let gridVisible = true;
    const gridSize = 40;
    let gridLines = [];

    function drawGrid() {
      gridLines.forEach(line => canvas.remove(line));
      gridLines = [];

      if (!gridVisible) return;

      for (let i = 0; i < canvas.width; i += gridSize) {
        const vertical = new fabric.Line([i, 0, i, canvas.height], {
          stroke: '#ccc', selectable: false, evented: false
        });
        gridLines.push(vertical);
        canvas.add(vertical);
      }
      for (let i = 0; i < canvas.height; i += gridSize) {
        const horizontal = new fabric.Line([0, i, canvas.width, i], {
          stroke: '#ccc', selectable: false, evented: false
        });
        gridLines.push(horizontal);
        canvas.add(horizontal);
      }
      gridLines.forEach(line => canvas.sendToBack(line));
    }

    drawGrid();

    function toggleGrid() {
      gridVisible = !gridVisible;
      drawGrid();
    }

    document.getElementById('fileUpload').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (f) {
        fabric.loadSVGFromString(f.target.result, function (objects, options) {
          const svg = fabric.util.groupSVGElements(objects, options);
          svg.set({ left: 100, top: 100, scaleX: 1, scaleY: 1 });
          canvas.add(svg);
        });
      };
      reader.readAsText(file);
    });

    function addText() {
      const text = new fabric.IText('Text', {
        left: 100,
        top: 150,
        fill: document.getElementById('colorPicker').value,
        fontFamily: document.getElementById('fontSelect').value,
        fontSize: 32
      });
      canvas.add(text);
    }

    document.getElementById('fontSelect').addEventListener('change', function () {
      const active = canvas.getActiveObject();
      if (active && active.type === 'i-text') {
        active.set("fontFamily", this.value);
        canvas.renderAll();
      }
    });

    document.getElementById('colorPicker').addEventListener('change', function () {
      const active = canvas.getActiveObject();
      if (active && active.set) {
        active.set("fill", this.value);
        canvas.renderAll();
      }
    });

    canvas.on('object:scaling', function (e) {
      const obj = e.target;
      obj.lockScalingFlip = true;
      obj.lockUniScaling = true;
    });

    canvas.on('object:rotating', function (e) {
      const snapAngles = [0, 90, 180, 270];
      const threshold = 5;
      let angle = e.target.angle;
      for (let snap of snapAngles) {
        if (Math.abs(angle - snap) < threshold) {
          e.target.angle = snap;
          break;
        }
      }
    });

    fabric.Object.prototype.set({
      transparentCorners: false,
      cornerStyle: 'circle',
      cornerSize: 10,
      borderColor: '#fff',
      cornerColor: '#fff',
      cornerStrokeColor: '#000',
      hasBorders: true,
      lockScalingFlip: true,
      lockUniScaling: true,
      hasControls: true,
      // remove side controls
      controls: {
        ml: false, mr: false, mt: false, mb: false
      }
    });

    function saveSVG() {
      const clone = canvas.clone();
      clone.getObjects().forEach(obj => {
        if (gridLines.includes(obj)) clone.remove(obj);
      });
      const svg = clone.toSVG({ width: exportWidth, height: exportHeight });
      const cleanedSVG = svg.replace(/\s(width|height)="[^"]*"/g, '')
                             .replace('<svg ', `<svg width="${exportWidth}mm" height="${exportHeight}mm" `);

      const blob = new Blob([cleanedSVG], { type: 'image/svg+xml' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'konfiguration.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      parent.postMessage({ scrollTo: '#formularanker' }, '*');
    }
  </script>
</body>
</html>
